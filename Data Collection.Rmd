
---
title: "Data Collection"
author: "Ellen Graham"
date: "November 4, 2018"
output: html_document
---

Suggestions From Brianna:

Possibly use difference or ratio of life expectancies 
Try doing both of them.
(Ratio if years more valuable younger or later)

Make different Models for different years

Find which variables missing (culprits for sparse data)
Inputting missing data for ~5 year chunks

Making maps of single vars (could even do through years! finally learn rshiny?)
(Which countries aren't there)
Brianna expects China and India

Try to model missing data for large missing countries (economic and health factors, maybe realted to gender to get a sense of what it might be based on relationships in countries of similar development levels)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(broom)
library(car)
library(tidyr)
library(qqplotr)
library(GGally)
```



Gapminder data
```{r}

filenames <- list.files(path="GapMinderData",pattern="*.csv", full.names=TRUE)
contraceptive<-read_csv(filenames[[1]])

nchar(filenames[[1]])

(name<-substring(filenames[[1]], 15, nchar(filenames[[1]])-4))
contraceptive<-contraceptive %>% 
   gather(key=year, value=temp, 2:length(contraceptive))
colnames(contraceptive)[1]<-"country"
colnames(contraceptive)[3]<-name
contraceptive[contraceptive == 0] <- NA
head(contraceptive)
```

```{r}
makeGapMinderTable<-function(file_path){
   table<-read_csv(file_path)
   name<-substring(file_path, 15, nchar(file_path)-4)
   table<-table %>% 
      gather(key=year, value=temp, 2:length(table))
   table
   colnames(table)[1]<-"country"
   colnames(table)[3]<-name
   table[table == 0] <- NA
   table
}
```

```{r}
allGapminderTables<-lapply(filenames, makeGapMinderTable)
```



```{r}
joined_Gapminder_tables<-allGapminderTables[[1]]
for(i in 2:length(allGapminderTables)){
      joined_Gapminder_tables<-full_join(joined_Gapminder_tables, allGapminderTables[[i]], by=c("country", "year"))
}

joined_Gapminder_tables<-joined_Gapminder_tables %>% 
   select(-age_at_1st_marriage_women)

dim(joined_Gapminder_tables)
na_free_table<-na.omit(joined_Gapminder_tables)

```

```{r}
kable(table(na_free_table$country))
kable(table(na_free_table$year))

```



Cleaning data
```{r}
clean_gapminder_tables<-joined_Gapminder_tables %>% 
   filter_at(vars(c(3:9)), any_vars(!is.na(.))) %>% 
   arrange(year)

cols.num<-c(2:9)
clean_gapminder_tables[cols.num] <- sapply(clean_gapminder_tables[cols.num],as.numeric)
```

Inputting missing data





```{r}
inputted_gapminder<-data.frame()
for(i in 0:30){
   five_years<-clean_gapminder_tables %>% 
      filter(1950+5*i-2<=year & year<=1950+5*i+2) %>% 
      mutate(year=1950+5*i) %>% 
      group_by(country, year) %>% 
      summarise_at(vars(c(3:9)), any_vars(mean(., na.rm=TRUE)))

   inputted_gapminder<-rbind.data.frame(inputted_gapminder, five_years)   
}

inputted_gapminder<-ungroup(inputted_gapminder) %>% 
   mutate(life_expectancy_diff=life_expectancy_female-life_expectancy_male) %>% 
   mutate(life_expectancy_ratio=life_expectancy_female/life_expectancy_male)
na_free_inputted<-na.omit(inputted_gapminder)

```



#Visualizations of Data

##Choropleths

```{r}
library(sf)


sfpath<-"Shapefiles\\TM_WORLD_BORDERS-0.3\\TM_WORLD_BORDERS-0.3.shp"

countries <- st_read(sfpath, quiet = TRUE)

```

```{r}
inputted_gapminder<-inputted_gapminder %>% 
   mutate(country=dplyr::recode(country, 'South Korea'='Korea, Republic of',
   "Lao"="Lao People's Democratic Republic", 
   "St. Vincent and the Grenadines"="Saint Vincent and the Grenadines", 
   "Syria"="Syrian Arab Republic",
   "Iran"="Iran (Islamic Republic of)",
   "Congo, Dem. Rep."="Democratic Republic of the Congo",
   "Congo, Rep."="Congo",
   "Kyrgyz Republic"="Kyrgyzstan",
   "Macedonia, FYR"="The former Yugoslav Republic of Macedonia", 
   "Moldova"="Republic of Moldova",
   "Myanmar"="Burma",
   "Slovak Republic"="Slovakia",
   "St. Lucia"="Saint Lucia",
   "Tanzania"="United Republic of Tanzania",
   "Vietnam"="Viet Nam", 
   "Brunei"="Brunei Darussalam",
   "Libya"="Libyan Arab Jamahiriya",
   "Micronesia, Fed. Sts."="Micronesia, Federated States of",
   "North Korea"="Korea, Democratic People's Republic of",
   "St. Kitts and Nevis"="Saint Kitts and Nevis"
   ))



sf_inputted<-countries %>% 
   right_join(inputted_gapminder, by=c("NAME"= "country")) %>% 
   arrange(NAME)
```

Simple features map
```{r, fig.width=10, fig.height=5}
library(viridis)

sf_inputted %>% 
   filter(year==2005) %>% 
   ggplot() +
   scale_fill_viridis("Female life expectancy")+
   geom_sf(aes(fill = life_expectancy_female)) +
   ggtitle("Life Expectancy 2005")

sf_inputted %>% 
   filter(year==2005) %>% 
   ggplot() +
   scale_fill_viridis("Female life expectancy")+
   geom_sf(aes(fill = life_expectancy_diff)) +
   ggtitle("Life Expectancy Difference 2005")

sf_inputted %>% 
   filter(year==2005) %>% 
   ggplot() +
   scale_fill_viridis("Female life expectancy")+
   geom_sf(aes(fill = life_expectancy_ratio)) +
   ggtitle("Life Expectancy Ratio 2005")
```


##ggpairs
```{r, fig.width=13, fig.height=13, message=FALSE}
inputted_gapminder %>% 
   filter(year==2005) %>% 
   ggpairs(columns=3:11)
```


```{r}
names(joined_Gapminder_tables)


lm.numerical<-inputted_gapminder %>% 
   filter(year==2005) %>% 
   lm(life_expectancy_diff~contraceptive_use_percent_of_women_ages_15_49+
                     males_aged_15plus_unemployment_rate_percent+
                     females_aged_15plus_unemployment_rate_percent+
                     ratio_of_girls_to_boys_in_primary_and_secondary_education_perc+
                     mean_years_in_school_women_percent_men_25_to_34_years,
                  data=.)


summary(lm.numerical)
```

```{r, fig.width=10, fig.height=10}
avPlots(lm.numerical)
```

```{r}
inputted_gapminder%>% 
   filter(year==2005) %>% 
   augment(lm.numerical, data=.) %>% 
   ggplot(aes(x=.fitted, y=.resid))+
   geom_point()+
   geom_hline(yintercept = 0)+
   labs(x="Fitted Values", y="Residuals")
```

Model building plan:
-Look into interaction terms using model comparison tests
-See how models are differnt for different years
-Compare life expectancy ratio and life expectency difference to variation across countries
-Find which variables are predictive
-Dealing with fanning and non-linearity in model 



