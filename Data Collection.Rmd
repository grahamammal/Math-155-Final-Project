
---
title: "Data Collection"
author: "Ellen Graham"
date: "November 4, 2018"
output: html_document
---

Suggestions From Brianna:

Possibly use difference or ratio of life expectancies 
Try doing both of them.
(Ratio if years more valuable younger or later)

Make different Models for different years

Find which variables missing (culprits for sparse data)
Inputting missing data for ~5 year chunks

Making maps of single vars (could even do through years! finally learn rshiny?)
(Which countries aren't there)
Brianna expects China and India

Try to model missing data for large missing countries (economic and health factors, maybe realted to gender to get a sense of what it might be based on relationships in countries of similar development levels)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(broom)
library(car)
library(tidyr)
library(qqplotr)
library(GGally)
```



Gapminder data
```{r}

filenames <- list.files(path="GapMinderData",pattern="*.csv", full.names=TRUE)
contraceptive<-read_csv(filenames[[1]])

nchar(filenames[[1]])

(name<-substring(filenames[[1]], 15, nchar(filenames[[1]])-4))
contraceptive<-contraceptive %>% 
   gather(key=year, value=temp, 2:length(contraceptive))
colnames(contraceptive)[1]<-"country"
colnames(contraceptive)[3]<-name
contraceptive[contraceptive == 0] <- NA
head(contraceptive)
```

```{r}
makeGapMinderTable<-function(file_path){
   table<-read_csv(file_path)
   name<-substring(file_path, 15, nchar(file_path)-4)
   table<-table %>% 
      gather(key=year, value=temp, 2:length(table))
   table
   colnames(table)[1]<-"country"
   colnames(table)[3]<-name
   table[table == 0] <- NA
   table
}
```

```{r}
allGapminderTables<-lapply(filenames, makeGapMinderTable)
```



```{r}
joined_Gapminder_tables<-allGapminderTables[[1]]
for(i in 2:length(allGapminderTables)){
      joined_Gapminder_tables<-full_join(joined_Gapminder_tables, allGapminderTables[[i]], by=c("country", "year"))
}

joined_Gapminder_tables<-joined_Gapminder_tables %>% 
   select(-age_at_1st_marriage_women)

dim(joined_Gapminder_tables)
na_free_table<-na.omit(joined_Gapminder_tables)

```

```{r}
kable(table(na_free_table$country))
kable(table(na_free_table$year))

```



Cleaning data
```{r}
clean_gapminder_tables<-joined_Gapminder_tables %>% 
   filter_at(vars(c(3:9)), any_vars(!is.na(.))) %>% 
   arrange(year)

cols.num<-c(2:9)
clean_gapminder_tables[cols.num] <- sapply(clean_gapminder_tables[cols.num],as.numeric)
```

Inputting missing data





```{r}
inputted_gapminder<-data.frame()
for(i in 0:30){
   five_years<-clean_gapminder_tables %>% 
      filter(1950+5*i-2<=year & year<=1950+5*i+2) %>% 
      mutate(year=1950+5*i) %>% 
      group_by(country, year) %>% 
      summarise_at(vars(c(3:9)), any_vars(mean(., na.rm=TRUE)))

   inputted_gapminder<-rbind.data.frame(inputted_gapminder, five_years)   
}

na_free_inputted<-ungroup(na.omit(inputted_gapminder))
```



#Visualizations of Data

##Choropleths

```{r}
library(sf)


sfpath<-"Shapefiles\\TM_WORLD_BORDERS-0.3\\TM_WORLD_BORDERS-0.3.shp"

countries <- st_read(sfpath, quiet = TRUE)

```

```{r}

as_tibble(countries)

as_tibble(countries %>% arrange(NAME))


na_free_inputted<-na_free_inputted %>% 
   mutate(country=dplyr::recode(country, 'South Korea'='Korea, Republic of',
   "Lao"="Lao People's Democratic Republic", 
   "St. Vincent and the Grenadines"="Saint Vincent and the Grenadines", 
   "Syria"="Syrian Arab Republic",
   "Iran"="Iran (Islamic Republic of)",
   "Congo, Dem. Rep."="Democratic Republic of the Congo",
   "Congo, Rep."="Congo",
   "Kyrgyz Republic"="Kyrgyzstan",
   "Macedonia, FYR"="The former Yugoslav Republic of Macedonia", 
   "Moldova"="Republic of Moldova",
   "Myanmar"="Burma",
   "Slovak Republic"="Slovakia",
   "St. Lucia"="Saint Lucia",
   "Tanzania"="United Republic of Tanzania",
   "Vietnam"="Viet Nam"
   ))



sf_na_free_inputted<-countries %>% 
   right_join(na_free_inputted, by=c("NAME"= "country")) %>% 
   arrange(NAME)

as_tibble(sf_na_free_inputted)
```

Simple features map
```{r, fig.width=10, fig.height=5}
library(viridis)

sf_na_free_inputted %>% 
   filter(year==2005) %>% 
   ggplot() +
   scale_fill_viridis("Female life expectancy")+
   geom_sf(aes(fill = life_expectancy_female)) +
   ggtitle("Life Expectancy 2005")
```


##ggpairs
```{r, fig.width=13, fig.height=13}
joined_Gapminder_tables %>% 
   ggpairs(columns=3:9)
```

```{r}
dim(joined_Gapminder_tables)
dim(na.omit(joined_Gapminder_tables))
names(joined_Gapminder_tables)

lm.numerical<-lm(life_expectancy_female~contraceptive_use_percent_of_women_ages_15_49+
                     males_aged_15plus_unemployment_rate_percent+
                     ratio_of_girls_to_boys_in_primary_and_secondary_education_perc+
                     females_aged_15plus_unemployment_rate_percent+
                     mean_years_in_school_women_percent_men_25_to_34_years, 
                  data=joined_Gapminder_tables)

summary(lm.numerical)
```

```{r, fig.width=10, fig.height=10}
avPlots(lm.numerical)
```

```{r}
augment(lm.numerical, data=joined_Gapminder_tables) %>% 
   ggplot(aes(x=.fitted, y=.resid))+
   geom_point()+
   geom_hline(yintercept = 0)+
   labs(x="Fitted Values", y="Residuals")
```

```{r}

```


##Histograms!

```{r}
head(joined_Gapminder_tables)
```

Years
```{r}
joined_Gapminder_tables %>% 
   ggplot() + 
   geom_histogram(aes(x=as.numeric(year)))
```

Contraceptive Use

```{r}
joined_Gapminder_tables %>% 
   ggplot(aes(x=contraceptive_use_percent_of_women_ages_15_49))+
   geom_histogram()
```

Females unemployment rate
```{r}
joined_Gapminder_tables %>% 
   ggplot(aes(x=females_aged_15plus_unemployment_rate_percent))+
   geom_histogram()
```

Males unemployment rate
```{r}
joined_Gapminder_tables %>% 
   ggplot(aes(x=males_aged_15plus_unemployment_rate_percent))+
   geom_histogram()
```

life Expectancy Female

```{r}

joined_Gapminder_tables %>% 
   ggplot(aes(x=life_expectancy_female))+
   geom_histogram()

```

Life Expectancy Male
```{r}
joined_Gapminder_tables %>% 
   ggplot(aes(x=life_expectancy_male))+
   geom_histogram()
```

Years in school
```{r}
joined_Gapminder_tables %>% 
   ggplot(aes(x=mean_years_in_school_women_percent_men_25_to_34_years))+
   geom_histogram()
```

Ratio of girls to boys primary+secondary education
```{r}
joined_Gapminder_tables %>% 
   ggplot(aes(x=ratio_of_girls_to_boys_in_primary_and_secondary_education_perc))+
   geom_histogram()
```

##Colored by year
```{r}
class(joined_Gapminder_tables$year)

joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot()+
   geom_point(aes(x=contraceptive_use_percent_of_women_ages_15_49, y=life_expectancy_female, color=as.numeric(year)))+
   scale_color_gradient(limits=c(1970, 2015))+
   geom_smooth(data=joined_Gapminder_tables, aes(x=contraceptive_use_percent_of_women_ages_15_49, y=life_expectancy_female, fill=year), method="lm", se=FALSE)+
   theme(legend.position="none")
```

```{r}
alldata.lm<-joined_Gapminder_tables %>% 
   group_by(year) %>% 
   filter(n()>5) %>% 
   lm(life_expectancy_female~contraceptive_use_percent_of_women_ages_15_49*year, data=.)

tidy(summary(alldata.lm))

temp<-joined_Gapminder_tables %>% 
   filter(!is.na(contraceptive_use_percent_of_women_ages_15_49), !is.na(life_expectancy_female))
cor(x=temp$contraceptive_use_percent_of_women_ages_15_49, y=temp$life_expectancy_female)
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot()+
   geom_point(aes(x=females_aged_15plus_unemployment_rate_percent, y=life_expectancy_female, color=as.numeric(year)))+
   scale_color_gradient(limits=c(1970, 2015))+
   geom_smooth(data=joined_Gapminder_tables, aes(x=females_aged_15plus_unemployment_rate_percent, y=life_expectancy_female, fill=year), method="lm", se=FALSE)+
   theme(legend.position="none")

#change

temp<-joined_Gapminder_tables %>% 
   filter(!is.na(females_aged_15plus_unemployment_rate_percent), !is.na(life_expectancy_female))
cor(x=temp$females_aged_15plus_unemployment_rate_percent, y=temp$life_expectancy_female)
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=males_aged_15plus_unemployment_rate_percent, y=life_expectancy_female, color=year))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

#change
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5, females_aged_15plus_unemployment_rate_percent/males_aged_15plus_unemployment_rate_percent<20) %>% 
   ggplot(aes(x=females_aged_15plus_unemployment_rate_percent/males_aged_15plus_unemployment_rate_percent, y=life_expectancy_female, color=year))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

#change
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=mean_years_in_school_women_percent_men_25_to_34_years, y=life_expectancy_female, color=year))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

```

```{r}
temp<-joined_Gapminder_tables %>% 
   filter(!is.na(mean_years_in_school_women_percent_men_25_to_34_years), !is.na(life_expectancy_female))
cor(x=temp$mean_years_in_school_women_percent_men_25_to_34_years, y=temp$life_expectancy_female)
```


```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=ratio_of_girls_to_boys_in_primary_and_secondary_education_perc, y=life_expectancy_female, color=year))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

```

##Colored by country
```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=contraceptive_use_percent_of_women_ages_15_49, y=life_expectancy_female, color=country))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

#change
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=females_aged_15plus_unemployment_rate_percent, y=life_expectancy_female, color=country))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

#change
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=males_aged_15plus_unemployment_rate_percent, y=life_expectancy_female, color=country))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

#change
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5, females_aged_15plus_unemployment_rate_percent/males_aged_15plus_unemployment_rate_percent<20) %>% 
   ggplot(aes(x=females_aged_15plus_unemployment_rate_percent/males_aged_15plus_unemployment_rate_percent, y=life_expectancy_female, color=country))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

#change
```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=mean_years_in_school_women_percent_men_25_to_34_years, y=life_expectancy_female, color=country))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

```

```{r}
joined_Gapminder_tables %>%
   group_by(year) %>% 
   filter(n()>5) %>% 
   ggplot(aes(x=ratio_of_girls_to_boys_in_primary_and_secondary_education_perc, y=life_expectancy_female, color=country))+
   geom_point()+
   geom_smooth(method="lm")+
   theme(legend.position="none")

```





